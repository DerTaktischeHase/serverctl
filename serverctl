#!/usr/bin/env bash
set -euo pipefail

VERSION="1.0.2"

REPO_RAW_URL="https://raw.githubusercontent.com/DerTaktischeHase/serverctl/main"
SELF_PATH="$HOME/.local/bin/serverctl"

get_remote_version() {
  command -v curl >/dev/null 2>&1 || return 1
  curl -fsSL --max-time 2 "$REPO_RAW_URL/serverctl" 2>/dev/null \
    | sed -n 's/^VERSION="\([^"]*\)".*/\1/p' \
    | head -n 1
}

ver_to_num() {
  # "1.2.3" -> 001002003 (fÃ¼r Vergleich)
  local v="${1:-0.0.0}"
  IFS='.' read -r a b c <<< "$v"
  printf "%03d%03d%03d" "${a:-0}" "${b:-0}" "${c:-0}"
}



# -------------------------------
# Update
# -------------------------------
if [[ "${1:-}" == "--update" ]]; then
  command -v curl >/dev/null 2>&1 || { echo "Fehler: curl fehlt (installiere mit: sudo apt install curl)"; exit 1; }

  remote_ver="$(get_remote_version || true)"
  if [[ -z "${remote_ver:-}" ]]; then
    echo "Fehler: Konnte Remote-Version nicht abrufen."
    exit 1
  fi

  if [[ "$(ver_to_num "$remote_ver")" -le "$(ver_to_num "$VERSION")" ]]; then
    echo "Kein Update nÃ¶tig. Lokal: $VERSION, Repo: $remote_ver"
    exit 0
  fi

  echo "Update verfÃ¼gbar: Lokal $VERSION â†’ Repo $remote_ver"
  read -rp "Jetzt aktualisieren? (y/N): " answer
  if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
    echo "Abgebrochen."
    exit 0
  fi

  tmp="$(mktemp)"
  curl -fsSL "$REPO_RAW_URL/serverctl" -o "$tmp"
  chmod +x "$tmp"
  mv "$tmp" "$SELF_PATH"

  echo "âœ“ Aktualisiert: $SELF_PATH"
  echo "Starte jetzt neu: serverctl"
  exit 0
fi


# -------------------------------
# Version
# -------------------------------

if [[ "${1:-}" == "--version" ]]; then
  echo "serverctl version $VERSION"
  exit 0
fi


# -------------------------------
# Uninstall
# -------------------------------
if [[ "${1:-}" == "--uninstall" ]]; then
  echo "serverctl wird deinstalliert."
  read -rp "Fortfahren? (y/N): " answer

  if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
    echo "Abgebrochen."
    exit 0
  fi

  BIN="$HOME/.local/bin/serverctl"
  BASHRC="$HOME/.bashrc"

  # Binary entfernen
  if [ -f "$BIN" ]; then
    rm -f "$BIN"
    echo "âœ“ Entfernt: $BIN"
  else
    echo "Hinweis: $BIN nicht gefunden"
  fi

  # SSH-Hinweis aus .bashrc entfernen
  if [ -f "$BASHRC" ] && grep -q "SERVERCTL_HINT_SHOWN" "$BASHRC"; then
    sed -i '/serverctl Hinweis bei SSH-Login/,+6d' "$BASHRC"
    echo "âœ“ SSH-Hinweis aus ~/.bashrc entfernt"
  fi

  echo
  echo "serverctl wurde erfolgreich deinstalliert."
  echo "Ã–ffne eine neue Shell, um die Ã„nderung zu Ã¼bernehmen."

  exit 0
fi

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  cat << 'EOF'
serverctl â€“ Server Wartungs- & Monitoring-Cockpit (SSH-freundlich)

Verwendung:
  serverctl              Zeigt die Server-Ãœbersicht
  serverctl --help       Diese Hilfe anzeigen
  serverctl --version    Zeigt welche Version du nutzt
  serverctl --update     Aktualisiert serverctl aus dem GitHub-Repo
  serverctl --uninstall  Deinstalliert serverctl (entfernt auch SSH-Hinweis aus ~/.bashrc)

Bearbeiten:
  nano ~/.local/bin/serverctl

Hinweise:
  - --update lÃ¤dt die Datei aus dem Repository und ersetzt ~/.local/bin/serverctl
  - Nach --uninstall ist serverctl entfernt und der Befehl nicht mehr verfÃ¼gbar.
EOF
  exit 0
fi

# -------------------------------
# Update Hinweis (nur Hinweis, kein Auto-Update)
# -------------------------------
remote_ver="$(get_remote_version || true)"
if [[ -n "${remote_ver:-}" && "$(ver_to_num "$remote_ver")" -gt "$(ver_to_num "$VERSION")" ]]; then
  echo "Hinweis: Update verfÃ¼gbar (lokal: $VERSION â†’ repo: $remote_ver). Nutze: serverctl --update"
  echo
fi


clear
echo "=================================================="
echo " serverctl  v${VERSION}   ($(hostname))"
echo "=================================================="
echo

echo "ðŸ–¥ï¸  System:"
uname -a
uptime || true
echo

echo "ðŸ”¥ Temperatur:"
if command -v vcgencmd >/dev/null 2>&1; then
  vcgencmd measure_temp || true
elif command -v sensors >/dev/null 2>&1; then
  sensors | head -n 8 || true
else
  echo "Temperatur nicht verfÃ¼gbar (Tipp: sudo apt install lm-sensors && sudo sensors-detect)"
fi
echo

echo "ðŸ§  RAM:"
if command -v free >/dev/null 2>&1; then
  free -h
else
  echo "free nicht verfÃ¼gbar (Tipp: sudo apt install procps)"
fi
echo

echo "ðŸ’¾ Speicher:"
df -h -x tmpfs -x devtmpfs 2>/dev/null || df -h || true
echo

echo "ðŸ“¦ Block-Devices:"
if command -v lsblk >/dev/null 2>&1; then
  lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINTS -e7 2>/dev/null || lsblk || true
else
  echo "lsblk nicht verfÃ¼gbar (Tipp: sudo apt install util-linux)"
fi
echo

echo "ðŸŒ Netzwerk:"
if command -v ip >/dev/null 2>&1; then
  ip -br a
else
  echo "ip nicht verfÃ¼gbar (Tipp: sudo apt install iproute2)"
fi
echo

echo "ðŸ”Œ Offene Ports:"
if command -v ss >/dev/null 2>&1; then
  ss -tulpn || true
else
  echo "ss nicht verfÃ¼gbar (Tipp: sudo apt install iproute2)"
fi
echo

echo "âš™ï¸ Services:"
SERVICES=(ssh sshd nginx docker node)
for svc in "${SERVICES[@]}"; do
  if systemctl list-unit-files 2>/dev/null | grep -q "^${svc}\.service"; then
    state="$(systemctl is-active "$svc" 2>/dev/null || true)"
    if [[ "$state" == "active" ]]; then
      echo "âœ“ ${svc} lÃ¤uft"
    else
      echo "âœ— ${svc} gestoppt"
    fi
  fi
done
echo

print_tool() {
  local tool="$1"
  local pkg="$2"

  if command -v "$tool" >/dev/null 2>&1; then
    printf "âœ“ %-10s (installiert)\n" "$tool"
  else
    printf "âœ— %-10s (nicht installiert) â†’ installiere mit: sudo apt install %s\n" "$tool" "$pkg"
  fi
}

echo "ðŸ§° Wartungstools (Status):"
echo
echo "[System]"
print_tool btop btop
print_tool htop htop
print_tool uptime coreutils
print_tool free procps
print_tool df coreutils
print_tool sensors lm-sensors
print_tool journalctl systemd

echo
echo "[Disk]"
print_tool ncdu ncdu
print_tool lsblk util-linux
print_tool mount util-linux
print_tool iostat sysstat
print_tool smartctl smartmontools

echo
echo "[Network]"
print_tool ip iproute2
print_tool ss iproute2
print_tool iftop iftop
print_tool lsof lsof
print_tool ping iputils-ping
print_tool traceroute traceroute

echo
echo "[Security]"
print_tool ufw ufw
print_tool fail2ban-client fail2ban
echo

echo "=================================================="
echo " MenÃ¼ bearbeiten:"
echo "  nano ~/.local/bin/serverctl"
echo "=================================================="
echo
